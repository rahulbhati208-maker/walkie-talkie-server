<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat X</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --wa-teal: #075e54; --my-msg: #dcf8c6; --rec-msg: #fff; --bg-gray: #f0f2f5; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; width: 100vw; height: 100vh; overflow: hidden; font-family: sans-serif; background: #000; }

        .app-shell { display: flex; width: 100%; height: 100%; background: #fff; }
        
        /* Sidebar */
        #sidebar { width: 30%; min-width: 320px; height: 100%; border-right: 1px solid #ddd; display: flex; flex-direction: column; background: #fff; z-index: 10; transition: transform 0.3s; }
        
        /* Chat Main */
        #chat-main { flex: 1; height: 100%; display: flex; flex-direction: column; background: #efe7dd; position: relative; transition: transform 0.3s; }
        
        /* Mobile Toggle */
        @media (max-width: 768px) {
            #sidebar { width: 100%; position: absolute; }
            #chat-main { width: 100%; position: absolute; left: 100%; }
            .view-chat #sidebar { transform: translateX(-100%); }
            .view-chat #chat-main { transform: translateX(-100%); }
        }

        .header { height: 60px; background: var(--wa-teal); color: white; display: flex; align-items: center; padding: 0 15px; justify-content: space-between; }
        
        /* Connection Dot */
        .conn-dot { width: 10px; height: 10px; border-radius: 50%; background: red; border: 1px solid white; transition: background 0.3s; margin-left: 10px; }
        .conn-online { background: #0f0; box-shadow: 0 0 5px #0f0; }

        /* Contact List */
        .contact-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .contact-item:hover { background: var(--bg-gray); }

        /* Chat Area */
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
        .msg { padding: 8px 12px; border-radius: 8px; max-width: 75%; margin-bottom: 6px; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word; position: relative; }
        .sent { align-self: flex-end; background: var(--my-msg); border-top-right-radius: 0; }
        .received { align-self: flex-start; background: var(--rec-msg); border-top-left-radius: 0; }
        .meta { font-size: 10px; color: #888; display: flex; justify-content: flex-end; gap: 4px; margin-top: 4px; }
        
        #input-area { background: var(--bg-gray); padding: 10px; display: flex; gap: 10px; align-items: center; }
        input { flex: 1; padding: 12px; border-radius: 20px; border: none; outline: none; }
        
        .typing { font-size: 12px; color: #fff; font-style: italic; opacity: 0.8; }
    </style>
</head>
<body>

<div class="app-shell">
    <div id="sidebar">
        <div class="header">
            <div style="display:flex; align-items:center;">
                <strong>Chat X</strong>
                <div id="status-dot-side" class="conn-dot" title="Connection Status"></div>
            </div>
        </div>
        <div id="contact-list" style="overflow-y:auto; flex:1;"></div>
    </div>

    <div id="chat-main">
        <div class="header">
            <div style="display:flex; align-items:center;">
                <span onclick="closeChat()" style="margin-right:15px; font-size:24px; cursor:pointer;">←</span>
                <div>
                    <strong id="chat-title">Select Chat</strong>
                    <div id="typing-ui" class="typing" style="display:none;">typing...</div>
                    <div id="last-seen-ui" style="font-size:10px; opacity:0.8;"></div>
                </div>
            </div>
            <div id="status-dot-main" class="conn-dot"></div>
        </div>
        
        <div id="chat-window"></div>
        
        <div id="input-area">
            <input type="text" id="msg-in" placeholder="Type a message..." oninput="handleTyping()">
            <button onclick="send()" style="border:none; background:var(--wa-teal); color:white; width:40px; height:40px; border-radius:50%; cursor:pointer;">➤</button>
        </div>
    </div>
</div>

<script>
    const socket = io();
    let myId = null;
    let activeChatId = null;
    let typingTimer;

    // --- 1. LOCAL STORAGE MANAGER ---
    const Store = {
        saveMsgs: (chatId, msgs) => {
            // Deduplicate based on ID
            const existing = Store.getMsgs(chatId);
            const map = new Map();
            existing.forEach(m => map.set(m.id, m)); // Load old
            msgs.forEach(m => map.set(m.id, m));     // Merge new
            const merged = Array.from(map.values()).sort((a,b) => new Date(a.created_at) - new Date(b.created_at));
            localStorage.setItem(`chat_msgs_${chatId}`, JSON.stringify(merged));
            return merged;
        },
        appendMsg: (chatId, msg) => {
            const msgs = Store.getMsgs(chatId);
            // check if exists
            if (!msgs.find(m => m.id === msg.id)) {
                msgs.push(msg);
                localStorage.setItem(`chat_msgs_${chatId}`, JSON.stringify(msgs));
            }
        },
        getMsgs: (chatId) => {
            return JSON.parse(localStorage.getItem(`chat_msgs_${chatId}`) || '[]');
        },
        saveContacts: (contacts) => localStorage.setItem('chat_contacts', JSON.stringify(contacts)),
        getContacts: () => JSON.parse(localStorage.getItem('chat_contacts') || '[]')
    };

    // --- 2. CONNECTION STATUS ---
    socket.on('connect', () => updateStatus(true));
    socket.on('disconnect', () => updateStatus(false));

    function updateStatus(online) {
        const cls = online ? 'conn-dot conn-online' : 'conn-dot';
        document.getElementById('status-dot-side').className = cls;
        document.getElementById('status-dot-main').className = cls;
    }

    // --- 3. INIT LOGIC ---
    async function init() {
        // 1. Get My ID
        const meRes = await fetch('/api/me');
        if (meRes.status === 401) return window.location.href = '/login';
        const meData = await meRes.json();
        myId = meData.myId;

        // 2. Load Contacts from LocalStorage (Fast)
        renderContacts(Store.getContacts());

        // 3. Fetch Fresh Contacts from Server (Background)
        const res = await fetch('/my-contacts');
        const contacts = await res.json();
        Store.saveContacts(contacts);
        renderContacts(contacts);
    }

    function renderContacts(contacts) {
        const list = document.getElementById('contact-list');
        list.innerHTML = contacts.map(c => {
            const name = (c.id === myId) ? `${c.profile_name} (You)` : c.profile_name;
            return `
            <div class="contact-item" onclick="openChat(${c.id}, '${name}', '${c.last_seen}')">
                <div>
                    <b>${name}</b><br>
                    <small style="color:#888">${c.last_seen ? new Date(c.last_seen).toLocaleDateString() : ''}</small>
                </div>
            </div>`;
        }).join('');
    }

    // --- 4. CHAT LOGIC ---
    async function openChat(id, name, lastSeen) {
        activeChatId = id;
        document.getElementById('chat-title').innerText = name;
        document.getElementById('last-seen-ui').innerText = id === myId ? '' : (lastSeen ? "Last seen: " + new Date(lastSeen).toLocaleTimeString() : 'Online');
        if(window.innerWidth < 768) document.body.classList.add('view-chat');

        // A. Load from LocalStorage (Instant)
        renderMsgs(Store.getMsgs(id));

        // B. Fetch Missed Messages from Server
        const res = await fetch(`/messages/${id}`);
        const serverMsgs = await res.json();
        
        // C. Merge & Save
        const merged = Store.saveMsgs(id, serverMsgs);
        renderMsgs(merged);
    }

    function renderMsgs(msgs) {
        const win = document.getElementById('chat-window');
        win.innerHTML = ''; // Clear current view
        msgs.forEach(m => {
            const div = document.createElement('div');
            div.className = 'msg ' + (m.sender_id == myId ? 'sent' : 'received');
            const time = new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            div.innerHTML = `${m.message}<div class="meta">${time}</div>`;
            win.appendChild(div);
        });
        win.scrollTop = win.scrollHeight;
    }

    // --- 5. SEND / RECEIVE ---
    function send() {
        const txt = document.getElementById('msg-in').value;
        if(!txt || !activeChatId) return;

        socket.emit('send-message', { toId: activeChatId, text: txt }, (ack) => {
            if(ack.success) {
                // Add to LocalStorage & View immediately
                Store.appendMsg(activeChatId, ack.msg);
                renderMsgs(Store.getMsgs(activeChatId));
            }
        });
        document.getElementById('msg-in').value = '';
    }

    socket.on('receive-message', (msg) => {
        // Decide which chat this belongs to
        // If I sent it (from another tab/device), it belongs to msg.receiver_id
        // If I received it, it belongs to msg.sender_id
        const chatId = (msg.sender_id === myId) ? msg.receiver_id : msg.sender_id; // logic handles self-chat too
        
        Store.appendMsg(chatId, msg);

        if(activeChatId === chatId || (activeChatId === myId && chatId === myId)) {
            renderMsgs(Store.getMsgs(activeChatId));
        }
    });
    
    // Also handle confirm for self-sent messages
    socket.on('msg-sent-confirm', (msg) => {
         Store.appendMsg(msg.receiver_id, msg);
         if(activeChatId === msg.receiver_id) renderMsgs(Store.getMsgs(activeChatId));
    });

    // --- 6. TYPING ---
    function handleTyping() {
        if(!activeChatId) return;
        socket.emit('typing', { toId: activeChatId });
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => socket.emit('stop-typing', { toId: activeChatId }), 3000);
    }

    socket.on('is-typing', d => { if(d.fromId == activeChatId) document.getElementById('typing-ui').style.display = 'block'; });
    socket.on('not-typing', d => { if(d.fromId == activeChatId) document.getElementById('typing-ui').style.display = 'none'; });

    function closeChat() { document.body.classList.remove('view-chat'); }
    
    init();
</script>
</body>
</html>
