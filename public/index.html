<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat X</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --wa-teal: #075e54; --my-msg: #dcf8c6; --rec-msg: #fff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; } /* Disable default text selection for better app feel */
        body { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; font-family: sans-serif; background: #000; }

        .app-shell { width: 100%; height: 100%; display: flex; background: #fff; }
        #sidebar { width: 30%; min-width: 320px; background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; transition: transform 0.3s; z-index: 2; }
        #chat-main { flex: 1; display: flex; flex-direction: column; background: #efe7dd; position: relative; transition: transform 0.3s; }
        
        @media (max-width: 768px) {
            #sidebar { width: 100%; position: absolute; }
            #chat-main { width: 100%; position: absolute; left: 100%; }
            .view-chat #sidebar { transform: translateX(-100%); }
            .view-chat #chat-main { transform: translateX(-100%); }
        }

        .header { height: 60px; background: var(--wa-teal); color: white; display: flex; align-items: center; padding: 0 15px; }
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
        
        /* MSG STYLES */
        .msg { position: relative; padding: 8px 12px; border-radius: 8px; max-width: 75%; margin-bottom: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .sent { align-self: flex-end; background: var(--my-msg); border-top-right-radius: 0; }
        .received { align-self: flex-start; background: var(--rec-msg); border-top-left-radius: 0; }
        .reply-preview { background: rgba(0,0,0,0.05); border-left: 4px solid var(--wa-teal); padding: 4px; font-size: 12px; margin-bottom: 4px; border-radius: 4px; }
        .footer { font-size: 10px; color: #888; display: flex; justify-content: flex-end; align-items: center; gap: 4px; margin-top: 4px; }
        
        /* CONTEXT MENU */
        #ctx-menu { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top-left-radius: 15px; border-top-right-radius: 15px; z-index: 100; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); padding: 20px; }
        .ctx-item { padding: 15px; border-bottom: 1px solid #eee; font-size: 16px; display: flex; gap: 10px; cursor: pointer; }
        .ctx-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 99; }

        /* FORWARD MODAL */
        #fwd-modal { display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: white; border-radius: 10px; padding: 20px; z-index: 101; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .fwd-list { max-height: 300px; overflow-y: auto; margin-top: 10px; }
        .fwd-user { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .fwd-user:hover { background: #f5f5f5; }

        /* FILTER BOX */
        #date-box { display: none; position: absolute; top: 60px; right: 10px; background: white; padding: 15px; z-index: 50; box-shadow: 0 4px 10px rgba(0,0,0,0.2); border-radius: 8px; }

        #input-area { background: #f0f0f0; padding: 10px; display: flex; gap: 10px; }
        input { flex: 1; padding: 10px; border-radius: 20px; border: none; outline: none; }
    </style>
</head>
<body>

<div class="app-shell">
    <div id="sidebar">
        <div class="header"><strong>Chat X</strong></div>
        <div id="contact-list" style="overflow-y:auto; flex:1;"></div>
    </div>
    <div id="chat-main">
        <div class="header">
            <span onclick="closeChat()" style="margin-right:15px; font-size:24px; cursor:pointer;">‚Üê</span>
            <div style="flex:1"><strong id="chat-name">Select Chat</strong></div>
            <button onclick="toggleFilter()" style="background:none; border:none; color:white; font-size:20px;">üìÖ</button>
            <div id="date-box">
                <input type="date" id="d-from"><br><br><input type="date" id="d-to"><br><br>
                <button onclick="applyFilter()">Filter</button>
            </div>
        </div>
        <div id="chat-window"></div>
        
        <div id="reply-bar" style="display:none; background:#eee; padding:10px; border-left:5px solid var(--wa-teal);">
            <span id="reply-txt" style="font-size:12px;"></span>
            <span onclick="cancelReply()" style="float:right; cursor:pointer;">√ó</span>
        </div>

        <div id="input-area">
            <input type="text" id="msg-in" placeholder="Type a message...">
            <button onclick="send()" style="border:none; background:var(--wa-teal); color:white; width:40px; height:40px; border-radius:50%;">‚û§</button>
        </div>
    </div>
</div>

<div class="ctx-overlay" id="overlay" onclick="closeMenu()"></div>
<div id="ctx-menu">
    <div class="ctx-item" onclick="menuAction('reply')">‚Ü© Reply</div>
    <div class="ctx-item" onclick="menuAction('copy')">üìã Copy</div>
    <div class="ctx-item" onclick="menuAction('forward')">‚è© Forward</div>
    <div class="ctx-item" onclick="menuAction('star')">‚≠ê Star / Unstar</div>
    <div class="ctx-item" style="color:red; text-align:center; display:block;" onclick="closeMenu()">Cancel</div>
</div>

<div id="fwd-modal">
    <h3>Forward to...</h3>
    <div class="fwd-list" id="fwd-list"></div>
    <button onclick="document.getElementById('fwd-modal').style.display='none'; document.getElementById('overlay').style.display='none';" style="margin-top:10px;">Close</button>
</div>

<script>
    const socket = io();
    let activeChatId = null;
    let selectedMsg = null; // { id, text, isStarred }
    let replyId = null;
    let contactCache = [];

    // --- 1. SWIPE & LONG PRESS LOGIC ---
    function attachMsgEvents(div, msg) {
        let startX = 0;
        let pressTimer;

        // Long Press
        div.addEventListener('touchstart', () => {
            pressTimer = setTimeout(() => openMenu(msg), 600);
        });
        div.addEventListener('touchend', () => clearTimeout(pressTimer));
        div.addEventListener('touchmove', () => clearTimeout(pressTimer)); // Cancel if scrolling

        // Swipe (Mobile only)
        div.addEventListener('touchstart', e => startX = e.touches[0].clientX);
        div.addEventListener('touchmove', e => {
            const diff = e.touches[0].clientX - startX;
            if (diff > 50) div.style.transform = `translateX(${Math.min(diff, 80)}px)`;
        });
        div.addEventListener('touchend', e => {
            const diff = e.changedTouches[0].clientX - startX;
            if (diff > 60) triggerReply(msg.id, msg.message);
            div.style.transform = 'translateX(0)';
        });
    }

    // --- 2. MENU ACTIONS ---
    function openMenu(msg) {
        selectedMsg = msg;
        document.getElementById('ctx-menu').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
        if(navigator.vibrate) navigator.vibrate(50);
    }

    function closeMenu() {
        document.getElementById('ctx-menu').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('fwd-modal').style.display = 'none';
    }

    async function menuAction(action) {
        closeMenu();
        if (!selectedMsg) return;

        if (action === 'reply') triggerReply(selectedMsg.id, selectedMsg.message);
        
        if (action === 'copy') {
            navigator.clipboard.writeText(selectedMsg.message);
            alert("Copied!");
        }

        if (action === 'star') {
            const newStatus = selectedMsg.is_starred ? 0 : 1;
            await fetch('/api/star-message', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ msgId: selectedMsg.id, isStarred: newStatus })
            });
            loadChat(activeChatId, document.getElementById('chat-name').innerText); // Refresh
        }

        if (action === 'forward') {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('fwd-modal').style.display = 'block';
            const list = document.getElementById('fwd-list');
            list.innerHTML = contactCache.map(c => `
                <div class="fwd-user" onclick="forwardTo(${c.id})">
                    <strong>${c.profile_name}</strong>
                </div>
            `).join('');
        }
    }

    function forwardTo(targetId) {
        socket.emit('send-message', { toId: targetId, text: selectedMsg.message });
        alert("Message forwarded!");
        closeMenu();
    }

    // --- 3. FILTER FIX ---
    function toggleFilter() {
        const d = document.getElementById('date-box');
        d.style.display = d.style.display === 'block' ? 'none' : 'block';
    }

    async function applyFilter() {
        const from = document.getElementById('d-from').value;
        const to = document.getElementById('d-to').value;
        if(!from || !to) return alert("Select both dates");
        
        const res = await fetch(`/messages/${activeChatId}?from=${from}&to=${to}`);
        const data = await res.json();
        renderMsgs(data.messages);
        toggleFilter();
    }

    // --- 4. CORE CHAT LOGIC ---
    async function loadContacts() {
        const res = await fetch('/my-contacts');
        contactCache = await res.json();
        document.getElementById('contact-list').innerHTML = contactCache.map(c => `
            <div onclick="loadChat(${c.id}, '${c.profile_name}')" style="padding:15px; border-bottom:1px solid #eee;">
                <b>${c.profile_name}</b> 
                ${c.unread_count > 0 ? `<span style="float:right; background:#25d366; color:white; border-radius:50%; padding:2px 6px;">${c.unread_count}</span>`:''}
            </div>
        `).join('');
    }

    async function loadChat(id, name) {
        activeChatId = id;
        document.getElementById('chat-name').innerText = name;
        if(window.innerWidth < 768) document.body.classList.add('view-chat');
        
        const res = await fetch(`/messages/${id}`);
        const data = await res.json();
        renderMsgs(data.messages);
    }

    function renderMsgs(msgs) {
        const win = document.getElementById('chat-window');
        win.innerHTML = '';
        msgs.forEach(m => {
            const div = document.createElement('div');
            div.className = 'msg ' + (m.sender_id == activeChatId ? 'received' : 'sent');
            
            const starHtml = m.is_starred ? '<span style="color:#f1c40f; margin-right:3px;">‚òÖ</span>' : '';
            const replyHtml = m.reply_text ? `<div class="reply-preview">${m.reply_text}</div>` : '';
            
            div.innerHTML = `${replyHtml}${m.message} 
                <div class="footer">${starHtml} ${new Date(m.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>`;
            
            attachMsgEvents(div, m); // Attach swipe/long-press
            win.appendChild(div);
        });
        win.scrollTop = win.scrollHeight;
    }

    function triggerReply(id, text) {
        replyId = id;
        document.getElementById('reply-bar').style.display = 'block';
        document.getElementById('reply-txt').innerText = "Replying to: " + text;
    }
    
    function cancelReply() {
        replyId = null;
        document.getElementById('reply-bar').style.display = 'none';
    }

    function send() {
        const txt = document.getElementById('msg-in').value;
        if(!txt || !activeChatId) return;
        socket.emit('send-message', { toId: activeChatId, text: txt, replyTo: replyId }, () => {
            loadChat(activeChatId, document.getElementById('chat-name').innerText);
            cancelReply();
        });
        document.getElementById('msg-in').value = '';
    }

    function closeChat() { document.body.classList.remove('view-chat'); }
    socket.on('receive-message', d => { if(d.fromId == activeChatId) loadChat(activeChatId, document.getElementById('chat-name').innerText); loadContacts(); });
    loadContacts();
</script>
</body>
</html>
